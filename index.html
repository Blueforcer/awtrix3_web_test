<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Einstellungen</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <!--link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Blueforcer/awtrix3_web_test/css/style.css"-->
    <!-- For development -->
    <link rel="stylesheet" href="css/style.css">
    <script src="js/script.js" defer></script>
    <!--script src="https://cdn.jsdelivr.net/gh/Blueforcer/awtrix3_web_test/js/script.js" defer></script-->

    <script type="module">
        import {
            GIFEncoder,
            quantize,
            applyPalette
        } from 'https://unpkg.com/gifenc@1.0.3';
        
    </script>

</head>
<body>
    <script>
        // Check if we need to configure the ESP IP
        if (!localStorage.getItem('espIp')) {
            const ip = prompt('Enter your ESP32 IP address:', '192.168.178.111');
            if (ip) {
                localStorage.setItem('espIp', ip);
            }
        }
    </script>
    <!-- Overlay für das Menü -->
    <div class="overlay" id="overlay"></div>

    <!-- Menü-Button -->
    <button class="menu-toggle" id="menu-toggle">
        <img src="https://cdn.jsdelivr.net/gh/Blueforcer/awtrix3_web_test/images/icon.png" alt="Logo" class="logo-image">
    </button>

    <aside class="sidebar">
        <div class="logo">
            <img src="https://cdn.jsdelivr.net/gh/Blueforcer/awtrix3_web_test/images/icon.png" alt="Logo" class="logo-image">
            AWTRIX 3
        </div>
        
        <nav>
            <a class="nav-item" data-page="dashboard">
                <i class="fa-solid fa-gauge"></i>
                Dashboard
            </a>
            <div class="nav-group">
                <a class="nav-item nav-item-parent">
                    <div class="nav-item-content">
                        <i class="fa-solid fa-network-wired"></i>
                        <span>Network</span>
                    </div>
                    <i class="fa-solid fa-chevron-down nav-arrow"></i>
                </a>
                <div class="nav-subitems">
                    <a class="nav-item sub-item" data-page="wifi">
                        <i class="fa-solid fa-wifi"></i>
                        <span>WLAN</span>
                    </a>
                    <a class="nav-item sub-item" data-page="mqtt">
                        <i class="fa-solid fa-server"></i>
                        <span>MQTT</span>
                    </a>
                    <a class="nav-item sub-item" data-page="network">
                        <i class="fa-solid fa-globe"></i>
                        <span>Network Settings</span>
                    </a>
                </div>
            </div>
            <a class="nav-item" data-page="time">
                <i class="fa-regular fa-clock"></i>
                Zeit
            </a>
            <div class="nav-group">
                <a class="nav-item nav-item-parent">
                    <div class="nav-item-content">
                        <i class="fa-regular fa-image"></i>
                        <span>Icons</span>
                    </div>
                    <i class="fa-solid fa-chevron-down nav-arrow"></i>
                </a>
                <div class="nav-subitems">
                    <a class="nav-item sub-item" data-page="icons">
                        <i class="fa-regular fa-images"></i>
                        <span>My Icons</span>
                    </a>
                    <a class="nav-item sub-item" data-page="creator">
                        <i class="fa-solid fa-paint-brush"></i>
                        <span>Creator</span>
                    </a>
                </div>
            </div>
            <a class="nav-item" data-page="settings">
                <i class="fa-solid fa-sliders"></i>
                Einstellungen
            </a>
        </nav>

        <footer class="sidebar-footer">
            <div>Version</div>
            <div>1.0</div>
        </footer>
    </aside>


    <button class="menu-toggle" id="menu-toggle">
        <i class="fa-solid fa-bars"></i>
        
    </button>

    <main id="content">
        
    </main>

    <script>
        const debug = document.getElementById('debug');
        function log(msg) {
            debug.innerHTML += msg + '<br>';
        }

        window.addEventListener('message', async function(event) {
            // Only accept messages from our web interface
            if (event.origin !== "https://blueforcer.github.io") return;
            
            try {
                // Strip the base URL and make local request
                const localUrl = event.data.url.replace(/^http:\/\/[^/]+/, '');
                
                // Handle image requests
                if (localUrl.startsWith('/ICONS/') && !event.data.method) {
                    // For image requests, return the full URL to the local resource
                    event.source.postMessage({
                        id: event.data.id,
                        success: true,
                        data: localUrl  // Return the local path
                    }, event.origin);
                    return;
                }
                
                const response = await fetch(localUrl, {
                    method: event.data.method || 'GET',
                    body: event.data.body ? event.data.body : undefined,
                    headers: event.data.body ? {'Content-Type': 'application/json'} : undefined
                });
                
                let data;
                if (event.data.method === 'POST') {
                    data = { success: true };
                } else {
                    try {
                        data = await response.json();
                    } catch (e) {
                        data = null;
                    }
                }
                
                event.source.postMessage({
                    id: event.data.id,
                    success: true,
                    data
                }, event.origin);
                
            } catch (error) {
                console.error('Error:', error);
                event.source.postMessage({
                    id: event.data.id,
                    success: false,
                    error: error.message
                }, event.origin);
            }
        });

        // Show debug panel on double tap
        document.addEventListener('dblclick', () => {
            debug.style.display = debug.style.display === 'none' ? 'block' : 'none';
        });
    </script>

</body>

</html>